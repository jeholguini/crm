"use strict";function e(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var r=e((e,{services:r,getSchema:i,database:t})=>{const{ItemsService:a}=r;async function n(e,r,i,t={}){if(!i||""===i.trim())return null;try{const a=await e.readByQuery({filter:{[r]:{_eq:i.trim()}},limit:1});if(a&&a.length>0)return a[0].id;return await e.createOne({[r]:i.trim(),...t})}catch(e){return console.error(`Error en findOrCreate para ${i}:`,e),null}}function s(e){return e?"string"==typeof e?e:JSON.stringify(e):null}function o(e){if(!e)return null;const r={"1-10":"1-10","11-50":"11-50","51-200":"51-200","51-250":"51-200","201-500":"201-500","501-1000":"501-1000","1000+":"1000+"};if(r[e])return r[e];const i=e.match(/(\d+)[-–](\d+)/);if(i){parseInt(i[1]);const e=parseInt(i[2]);return e<=10?"1-10":e<=50?"11-50":e<=200||e<=250?"51-200":e<=500?"201-500":e<=1e3?"501-1000":"1000+"}return null}function c(e){if(!e)return null;return 3===e.length?e.toUpperCase():{"España":"ESP",Spain:"ESP",Colombia:"COL",Argentina:"ARG",Brasil:"BRA",Brazil:"BRA",Chile:"CHL","México":"MEX",Mexico:"MEX","Perú":"PER",Peru:"PER","Estados Unidos":"USA","United States":"USA",USA:"USA"}[e]||null}function l(e){if(!e)return null;return{CIF:"OTHER",NIF:"OTHER",NIT:"NIT",RUT:"RUT",RUC:"RUC",CUIT:"CUIT",CNPJ:"CNPJ",RFC:"RFC"}[e.toUpperCase()]||"OTHER"}function u(e){if(!e)return null;return{"LTB IA":"other","Sitio web":"website",Website:"website",Referido:"referral",LinkedIn:"linkedin",Publicidad:"advertising",Evento:"event","Cold outreach":"cold_outreach",Otro:"other"}[e]||"other"}e.get("/test",(e,r)=>{r.json({success:!0,message:"Extensión de upsert de empresas funcionando",timestamp:(new Date).toISOString(),routes:["GET /test - Prueba de conectividad","POST /upsert - Crear o actualizar empresas desde JSON"]})}),e.post("/upsert",async(e,r)=>{try{const t=e.body;if(!Array.isArray(t))return r.status(400).json({success:!1,error:"El cuerpo debe ser un array de objetos de empresas"});if(0===t.length)return r.status(400).json({success:!1,error:"El array no puede estar vacío"});const d=await i(),m=new a("enterprises",{schema:d,accountability:e.accountability}),f=new a("industries",{schema:d,accountability:e.accountability}),p=new a("tags",{schema:d,accountability:e.accountability}),g=new a("enterprises_industries",{schema:d,accountability:e.accountability}),y=new a("enterprises_tags",{schema:d,accountability:e.accountability}),_=[],h=[];for(let e=0;e<t.length;e++)try{const r=t[e],i=r["Nombre de la organización"],a=r["Identificación fiscal"];if(!(i&&""!==i.trim()||a&&""!==a.trim())){h.push({index:e,error:'Se requiere al menos "Nombre de la organización" o "Identificación fiscal"'});continue}let d=null;if(a&&a.trim()){const e=await m.readByQuery({filter:{fiscal_identification:{_eq:a.trim()}},limit:1,fields:["id","organization_name"]});e&&e.length>0&&(d=e[0])}if(!d&&i&&i.trim()){const e=await m.readByQuery({filter:{organization_name:{_eq:i.trim()}},limit:1,fields:["id","organization_name"]});e&&e.length>0&&(d=e[0])}const b={};if(i&&i.trim())b.organization_name=i.trim();else if(!d){h.push({index:e,error:"Nombre de la organización es requerido para crear una nueva empresa"});continue}let w,E;if(r["Nombre comercial / marca"]&&(b.commercial_name=r["Nombre comercial / marca"].trim()),r.LinkedIn&&(b.linkedin=r.LinkedIn.trim()),r["Tipo de identificación fiscal"]&&(b.fiscal_identification_type=l(r["Tipo de identificación fiscal"])),a&&(b.fiscal_identification=a.trim()),r["Tamaño de la empresa (rango empleados)"]&&(b.company_size=o(r["Tamaño de la empresa (rango empleados)"])),r["País"]&&(b.country=c(r["País"])),r.Direccion&&(b.normalized_address=s(r.Direccion)),r["Sitio web"]&&(b.website=r["Sitio web"].trim()),r["Teléfono – prefijo"]&&(b.phone_prefix=r["Teléfono – prefijo"].trim()),r["Teléfono – número"]&&(b.phone_number=r["Teléfono – número"].trim()),r["Fuente de adquisición"]&&(b.acquisition_source=u(r["Fuente de adquisición"])),r["Propietario interno"]&&(b.internal_owner=r["Propietario interno"].trim()),r.Notas&&(b.notes=r.Notas.trim()),d?(await m.updateOne(d.id,b),w=d.id,E="updated"):(w=await m.createOne(b),E="created"),r["Sector / industria"]){const e=r["Sector / industria"],i=await n(f,"name",e);if(i)try{const e=await g.readByQuery({filter:{_and:[{enterprises_id:{_eq:w}},{industries_id:{_eq:i}}]},limit:1});e&&0!==e.length||await g.createOne({enterprises_id:w,industries_id:i})}catch(e){console.error("Error creando relación industria:",e)}}if(r["Etiquetas / tags"]&&Array.isArray(r["Etiquetas / tags"]))for(const e of r["Etiquetas / tags"]){const r=await n(p,"name",e);if(r)try{const e=await y.readByQuery({filter:{_and:[{enterprises_id:{_eq:w}},{tags_id:{_eq:r}}]},limit:1});e&&0!==e.length||await y.createOne({enterprises_id:w,tags_id:r})}catch(e){console.error("Error creando relación tag:",e)}}_.push({index:e,organization_name:i&&i.trim()?i.trim():d?.organization_name||"N/A",action:E,id:w})}catch(r){console.error(`Error procesando empresa ${e}:`,r),h.push({index:e,error:r.message})}r.json({success:!0,message:`Procesadas ${_.length} empresas de ${t.length} total.`,data:{processed:t.length,successful:_.length,errors:h.length,results:_,errorDetails:h}})}catch(e){console.error("Error en upsert de empresas:",e),r.status(500).json({success:!1,error:e.message})}})});module.exports=r;
