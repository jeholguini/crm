"use strict";var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function t(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var s={},r={},i={},n={};Object.defineProperty(n,"__esModule",{value:!0}),n.default=function(e){return null==e?"":`${e}`};var o={};Object.defineProperty(o,"__esModule",{value:!0}),o.default=function(e={}){const{separator:t,decimals:s}=e;return t?s?e=>e.toFixed(s).replace(".",t):e=>`${e}`.replace(".",t):s?e=>e.toFixed(s):e=>`${e}`};var a={};Object.defineProperty(a,"__esModule",{value:!0}),a.default=function(e={}){const t="string"==typeof e.quote?e.quote:'"',s="string"==typeof e.escapedQuote?e.escapedQuote:`${t}${t}`;if(!t||t===s)return e=>e;const r=new RegExp(t,"g");return e=>(e.includes(t)&&(e=e.replace(r,s)),`${t}${e}${t}`)};var u={},f=e&&e.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(u,"__esModule",{value:!0});const h=f(a);u.default=function(e={}){const t="string"==typeof e.quote?e.quote:'"',s="string"==typeof e.escapedQuote?e.escapedQuote:`${t}${t}`,r="string"==typeof e.separator?e.separator:",",i="string"==typeof e.eol?e.eol:"\n",n=(0,h.default)({quote:t,escapedQuote:s});return e=>[t,r,i].some(t=>e.includes(t))?n(e):e};var _={};Object.defineProperty(_,"__esModule",{value:!0});const T=new RegExp('"',"g");_.default=function(e){return`"=""${e.replace(T,'""""')}"""`};var d={},c=e&&e.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(d,"__esModule",{value:!0});const E=c(a);d.default=function(e={stringFormatter:(0,E.default)()}){return t=>e.stringFormatter(t.toString().slice(7,-1))};var l={},L=e&&e.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(l,"__esModule",{value:!0});const A=L(a);l.default=function(e={stringFormatter:(0,A.default)()}){return t=>{if(null===t)return"";let s=JSON.stringify(t);return void 0===s?"":('"'===s[0]&&(s=s.replace(/^"(.+)"$/,"$1")),e.stringFormatter(s))}},function(t){var s=e&&e.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.object=t.symbol=t.stringExcel=t.stringQuoteOnlyIfNecessary=t.string=t.number=t.default=void 0;var r=n;Object.defineProperty(t,"default",{enumerable:!0,get:function(){return s(r).default}});var i=o;Object.defineProperty(t,"number",{enumerable:!0,get:function(){return s(i).default}});var f=a;Object.defineProperty(t,"string",{enumerable:!0,get:function(){return s(f).default}});var h=u;Object.defineProperty(t,"stringQuoteOnlyIfNecessary",{enumerable:!0,get:function(){return s(h).default}});var T=_;Object.defineProperty(t,"stringExcel",{enumerable:!0,get:function(){return s(T).default}});var c=d;Object.defineProperty(t,"symbol",{enumerable:!0,get:function(){return s(c).default}});var E=l;Object.defineProperty(t,"object",{enumerable:!0,get:function(){return s(E).default}})}(i);var p={};Object.defineProperty(p,"__esModule",{value:!0}),p.fastJoin=p.flattenReducer=p.getProp=void 0;const I=RegExp("[^.[\\]]+|\\[(?:([^\"'][^[]*)|([\"'])((?:(?!\\2)[^\\\\]|\\\\.)*?)\\2)\\]|(?=(?:\\.|\\[\\])(?:\\.|\\[\\]|$))","g");p.getProp=function(e,t,s){if(t in e){const r=e[t];return void 0===r?s:r}const r=Array.isArray(t)?t:function(e){var t,s,r;const i=[];let n;for(;n=I.exec(e);)i.push(null!==(r=null!==(t=n[3])&&void 0!==t?t:null===(s=n[1])||void 0===s?void 0:s.trim())&&void 0!==r?r:n[0]);return i}(t);let i=e;for(const e of r)if(i=null==i?void 0:i[e],void 0===i)return s;return i},p.flattenReducer=function(e,t){try{return Array.isArray(t)?e.push(...t):e.push(t),e}catch(s){return e.concat(t)}},p.fastJoin=function(e,t){let s=!0;return e.reduce((e,r)=>(null==r&&(r=""),s?(s=!1,`${r}`):`${e}${t}${r}`),"")};var R=e&&e.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,i)}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),N=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),b=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&R(t,e,s);return N(t,e),t};Object.defineProperty(r,"__esModule",{value:!0}),r.FormatterTypes=void 0;const S=b(i),m=p;var g;!function(e){e.header="header",e[void 0]="undefined",e.boolean="boolean",e.number="number",e.bigint="bigint",e.string="string",e.symbol="symbol",e.function="function",e.object="object"}(g||(r.FormatterTypes=g={}));r.default=class{constructor(e){this.opts=this.preprocessOpts(e)}preprocessOpts(e){const t=Object.assign({},e);t.fields&&(t.fields=this.preprocessFieldsInfo(t.fields,t.defaultValue)),t.transforms=t.transforms||[];const s=t.formatters&&t.formatters.string||(0,S.string)(),r=(0,S.object)({stringFormatter:s}),i={header:s,undefined:S.default,boolean:S.default,number:(0,S.number)(),bigint:S.default,string:s,symbol:(0,S.symbol)({stringFormatter:s}),function:r,object:r};return t.formatters=Object.assign(Object.assign({},i),t.formatters),t.delimiter=t.delimiter||",",t.eol=t.eol||"\n",t.header=!1!==t.header,t.includeEmptyRows=t.includeEmptyRows||!1,t.withBOM=t.withBOM||!1,t}preprocessFieldsInfo(e,t){return e.map(e=>{if("string"==typeof e)return{label:e,value:s=>(0,m.getProp)(s,e,t)};if("object"==typeof e){const s="default"in e?e.default:t;if("string"==typeof e.value){const t=e.value;return{label:e.label||e.value,value:e=>(0,m.getProp)(e,t,s)}}if("function"==typeof e.value){const t=e.label||e.value.name||"",r={label:t,default:s},i=e.value;return{label:t,value(e){const t=i(e,r);return void 0===t?s:t}}}}throw new Error("Invalid field info option. "+JSON.stringify(e))})}getHeader(){return(0,m.fastJoin)(this.opts.fields.map(e=>this.opts.formatters.header(e.label)),this.opts.delimiter)}preprocessRow(e){return this.opts.transforms.reduce((e,t)=>e.map(e=>t(e)).reduce(m.flattenReducer,[]),[e])}processRow(e){if(!e)return;const t=this.opts.fields.map(t=>this.processCell(e,t));return this.opts.includeEmptyRows||!t.every(e=>""===e)?(0,m.fastJoin)(t,this.opts.delimiter):void 0}processCell(e,t){return this.processValue(t.value(e))}processValue(e){return(0,this.opts.formatters[typeof e])(e)}};var O={},y=e&&e.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(O,"__esModule",{value:!0});const k=y(r),P=p;class C extends k.default{constructor(e){super(e)}parse(e){const t=this.preprocessData(e);this.opts.fields=this.opts.fields||this.preprocessFieldsInfo(t.reduce((e,t)=>(Object.keys(t).forEach(t=>{e.includes(t)||e.push(t)}),e),[]),this.opts.defaultValue);const s=this.opts.header?this.getHeader():"",r=this.processData(t);return(this.opts.withBOM?"\ufeff":"")+s+(s&&r?this.opts.eol:"")+r}preprocessData(e){const t=Array.isArray(e)?e:[e];if(!this.opts.fields){if(null==e||0===t.length)throw new Error('Data should not be empty or the "fields" option should be included');if("object"!=typeof t[0])throw new Error('Data items should be objects or the "fields" option should be included')}return 0===this.opts.transforms.length?t:t.map(e=>this.preprocessRow(e)).reduce(P.flattenReducer,[])}processData(e){return(0,P.fastJoin)(e.map(e=>this.processRow(e)).filter(e=>e),this.opts.eol)}}O.default=C;var v,M={},U={},D={},B={},w={};Object.defineProperty(w,"__esModule",{value:!0}),w.escapedSequences=w.charset=void 0,function(e){e[e.BACKSPACE=8]="BACKSPACE",e[e.FORM_FEED=12]="FORM_FEED",e[e.NEWLINE=10]="NEWLINE",e[e.CARRIAGE_RETURN=13]="CARRIAGE_RETURN",e[e.TAB=9]="TAB",e[e.SPACE=32]="SPACE",e[e.EXCLAMATION_MARK=33]="EXCLAMATION_MARK",e[e.QUOTATION_MARK=34]="QUOTATION_MARK",e[e.NUMBER_SIGN=35]="NUMBER_SIGN",e[e.DOLLAR_SIGN=36]="DOLLAR_SIGN",e[e.PERCENT_SIGN=37]="PERCENT_SIGN",e[e.AMPERSAND=38]="AMPERSAND",e[e.APOSTROPHE=39]="APOSTROPHE",e[e.LEFT_PARENTHESIS=40]="LEFT_PARENTHESIS",e[e.RIGHT_PARENTHESIS=41]="RIGHT_PARENTHESIS",e[e.ASTERISK=42]="ASTERISK",e[e.PLUS_SIGN=43]="PLUS_SIGN",e[e.COMMA=44]="COMMA",e[e.HYPHEN_MINUS=45]="HYPHEN_MINUS",e[e.FULL_STOP=46]="FULL_STOP",e[e.SOLIDUS=47]="SOLIDUS",e[e.DIGIT_ZERO=48]="DIGIT_ZERO",e[e.DIGIT_ONE=49]="DIGIT_ONE",e[e.DIGIT_TWO=50]="DIGIT_TWO",e[e.DIGIT_THREE=51]="DIGIT_THREE",e[e.DIGIT_FOUR=52]="DIGIT_FOUR",e[e.DIGIT_FIVE=53]="DIGIT_FIVE",e[e.DIGIT_SIX=54]="DIGIT_SIX",e[e.DIGIT_SEVEN=55]="DIGIT_SEVEN",e[e.DIGIT_EIGHT=56]="DIGIT_EIGHT",e[e.DIGIT_NINE=57]="DIGIT_NINE",e[e.COLON=58]="COLON",e[e.SEMICOLON=59]="SEMICOLON",e[e.LESS_THAN_SIGN=60]="LESS_THAN_SIGN",e[e.EQUALS_SIGN=61]="EQUALS_SIGN",e[e.GREATER_THAN_SIGN=62]="GREATER_THAN_SIGN",e[e.QUESTION_MARK=63]="QUESTION_MARK",e[e.COMMERCIAL_AT=64]="COMMERCIAL_AT",e[e.LATIN_CAPITAL_LETTER_A=65]="LATIN_CAPITAL_LETTER_A",e[e.LATIN_CAPITAL_LETTER_B=66]="LATIN_CAPITAL_LETTER_B",e[e.LATIN_CAPITAL_LETTER_C=67]="LATIN_CAPITAL_LETTER_C",e[e.LATIN_CAPITAL_LETTER_D=68]="LATIN_CAPITAL_LETTER_D",e[e.LATIN_CAPITAL_LETTER_E=69]="LATIN_CAPITAL_LETTER_E",e[e.LATIN_CAPITAL_LETTER_F=70]="LATIN_CAPITAL_LETTER_F",e[e.LATIN_CAPITAL_LETTER_G=71]="LATIN_CAPITAL_LETTER_G",e[e.LATIN_CAPITAL_LETTER_H=72]="LATIN_CAPITAL_LETTER_H",e[e.LATIN_CAPITAL_LETTER_I=73]="LATIN_CAPITAL_LETTER_I",e[e.LATIN_CAPITAL_LETTER_J=74]="LATIN_CAPITAL_LETTER_J",e[e.LATIN_CAPITAL_LETTER_K=75]="LATIN_CAPITAL_LETTER_K",e[e.LATIN_CAPITAL_LETTER_L=76]="LATIN_CAPITAL_LETTER_L",e[e.LATIN_CAPITAL_LETTER_M=77]="LATIN_CAPITAL_LETTER_M",e[e.LATIN_CAPITAL_LETTER_N=78]="LATIN_CAPITAL_LETTER_N",e[e.LATIN_CAPITAL_LETTER_O=79]="LATIN_CAPITAL_LETTER_O",e[e.LATIN_CAPITAL_LETTER_P=80]="LATIN_CAPITAL_LETTER_P",e[e.LATIN_CAPITAL_LETTER_Q=81]="LATIN_CAPITAL_LETTER_Q",e[e.LATIN_CAPITAL_LETTER_R=82]="LATIN_CAPITAL_LETTER_R",e[e.LATIN_CAPITAL_LETTER_S=83]="LATIN_CAPITAL_LETTER_S",e[e.LATIN_CAPITAL_LETTER_T=84]="LATIN_CAPITAL_LETTER_T",e[e.LATIN_CAPITAL_LETTER_U=85]="LATIN_CAPITAL_LETTER_U",e[e.LATIN_CAPITAL_LETTER_V=86]="LATIN_CAPITAL_LETTER_V",e[e.LATIN_CAPITAL_LETTER_W=87]="LATIN_CAPITAL_LETTER_W",e[e.LATIN_CAPITAL_LETTER_X=88]="LATIN_CAPITAL_LETTER_X",e[e.LATIN_CAPITAL_LETTER_Y=89]="LATIN_CAPITAL_LETTER_Y",e[e.LATIN_CAPITAL_LETTER_Z=90]="LATIN_CAPITAL_LETTER_Z",e[e.LEFT_SQUARE_BRACKET=91]="LEFT_SQUARE_BRACKET",e[e.REVERSE_SOLIDUS=92]="REVERSE_SOLIDUS",e[e.RIGHT_SQUARE_BRACKET=93]="RIGHT_SQUARE_BRACKET",e[e.CIRCUMFLEX_ACCENT=94]="CIRCUMFLEX_ACCENT",e[e.LOW_LINE=95]="LOW_LINE",e[e.GRAVE_ACCENT=96]="GRAVE_ACCENT",e[e.LATIN_SMALL_LETTER_A=97]="LATIN_SMALL_LETTER_A",e[e.LATIN_SMALL_LETTER_B=98]="LATIN_SMALL_LETTER_B",e[e.LATIN_SMALL_LETTER_C=99]="LATIN_SMALL_LETTER_C",e[e.LATIN_SMALL_LETTER_D=100]="LATIN_SMALL_LETTER_D",e[e.LATIN_SMALL_LETTER_E=101]="LATIN_SMALL_LETTER_E",e[e.LATIN_SMALL_LETTER_F=102]="LATIN_SMALL_LETTER_F",e[e.LATIN_SMALL_LETTER_G=103]="LATIN_SMALL_LETTER_G",e[e.LATIN_SMALL_LETTER_H=104]="LATIN_SMALL_LETTER_H",e[e.LATIN_SMALL_LETTER_I=105]="LATIN_SMALL_LETTER_I",e[e.LATIN_SMALL_LETTER_J=106]="LATIN_SMALL_LETTER_J",e[e.LATIN_SMALL_LETTER_K=107]="LATIN_SMALL_LETTER_K",e[e.LATIN_SMALL_LETTER_L=108]="LATIN_SMALL_LETTER_L",e[e.LATIN_SMALL_LETTER_M=109]="LATIN_SMALL_LETTER_M",e[e.LATIN_SMALL_LETTER_N=110]="LATIN_SMALL_LETTER_N",e[e.LATIN_SMALL_LETTER_O=111]="LATIN_SMALL_LETTER_O",e[e.LATIN_SMALL_LETTER_P=112]="LATIN_SMALL_LETTER_P",e[e.LATIN_SMALL_LETTER_Q=113]="LATIN_SMALL_LETTER_Q",e[e.LATIN_SMALL_LETTER_R=114]="LATIN_SMALL_LETTER_R",e[e.LATIN_SMALL_LETTER_S=115]="LATIN_SMALL_LETTER_S",e[e.LATIN_SMALL_LETTER_T=116]="LATIN_SMALL_LETTER_T",e[e.LATIN_SMALL_LETTER_U=117]="LATIN_SMALL_LETTER_U",e[e.LATIN_SMALL_LETTER_V=118]="LATIN_SMALL_LETTER_V",e[e.LATIN_SMALL_LETTER_W=119]="LATIN_SMALL_LETTER_W",e[e.LATIN_SMALL_LETTER_X=120]="LATIN_SMALL_LETTER_X",e[e.LATIN_SMALL_LETTER_Y=121]="LATIN_SMALL_LETTER_Y",e[e.LATIN_SMALL_LETTER_Z=122]="LATIN_SMALL_LETTER_Z",e[e.LEFT_CURLY_BRACKET=123]="LEFT_CURLY_BRACKET",e[e.VERTICAL_LINE=124]="VERTICAL_LINE",e[e.RIGHT_CURLY_BRACKET=125]="RIGHT_CURLY_BRACKET",e[e.TILDE=126]="TILDE"}(v||(w.charset=v={})),w.escapedSequences={34:34,92:92,47:47,98:8,102:12,110:10,114:13,116:9};var G={};Object.defineProperty(G,"__esModule",{value:!0}),G.BufferedString=G.NonBufferedString=void 0;G.NonBufferedString=class{constructor(){this.decoder=new TextDecoder("utf-8"),this.strings=[],this.byteLength=0}appendChar(e){this.strings.push(String.fromCharCode(e)),this.byteLength+=1}appendBuf(e,t=0,s=e.length){this.strings.push(this.decoder.decode(e.subarray(t,s))),this.byteLength+=s-t}reset(){this.strings=[],this.byteLength=0}toString(){return this.strings.join("")}};G.BufferedString=class{constructor(e){this.decoder=new TextDecoder("utf-8"),this.bufferOffset=0,this.string="",this.byteLength=0,this.buffer=new Uint8Array(e)}appendChar(e){this.bufferOffset>=this.buffer.length&&this.flushStringBuffer(),this.buffer[this.bufferOffset++]=e,this.byteLength+=1}appendBuf(e,t=0,s=e.length){const r=s-t;this.bufferOffset+r>this.buffer.length&&this.flushStringBuffer(),this.buffer.set(e.subarray(t,s),this.bufferOffset),this.bufferOffset+=r,this.byteLength+=r}flushStringBuffer(){this.string+=this.decoder.decode(this.buffer.subarray(0,this.bufferOffset)),this.bufferOffset=0}reset(){this.string="",this.bufferOffset=0,this.byteLength=0}toString(){return this.flushStringBuffer(),this.string}};var j,F={};Object.defineProperty(F,"__esModule",{value:!0}),function(e){e[e.LEFT_BRACE=0]="LEFT_BRACE",e[e.RIGHT_BRACE=1]="RIGHT_BRACE",e[e.LEFT_BRACKET=2]="LEFT_BRACKET",e[e.RIGHT_BRACKET=3]="RIGHT_BRACKET",e[e.COLON=4]="COLON",e[e.COMMA=5]="COMMA",e[e.TRUE=6]="TRUE",e[e.FALSE=7]="FALSE",e[e.NULL=8]="NULL",e[e.STRING=9]="STRING",e[e.NUMBER=10]="NUMBER",e[e.SEPARATOR=11]="SEPARATOR"}(j||(j={})),F.default=j;var H=e&&e.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(B,"__esModule",{value:!0}),B.TokenizerError=void 0;const z=w,x=G,$=H(F);var K;function V(e){return["START","ENDED","ERROR","TRUE1","TRUE2","TRUE3","FALSE1","FALSE2","FALSE3","FALSE4","NULL1","NULL2","NULL3","STRING_DEFAULT","STRING_AFTER_BACKSLASH","STRING_UNICODE_DIGIT_1","STRING_UNICODE_DIGIT_2","STRING_UNICODE_DIGIT_3","STRING_UNICODE_DIGIT_4","STRING_INCOMPLETE_CHAR","NUMBER_AFTER_INITIAL_MINUS","NUMBER_AFTER_INITIAL_ZERO","NUMBER_AFTER_INITIAL_NON_ZERO","NUMBER_AFTER_FULL_STOP","NUMBER_AFTER_DECIMAL","NUMBER_AFTER_E","NUMBER_AFTER_E_AND_SIGN","NUMBER_AFTER_E_AND_DIGIT","SEPARATOR","BOM_OR_START","BOM"][e]}!function(e){e[e.START=0]="START",e[e.ENDED=1]="ENDED",e[e.ERROR=2]="ERROR",e[e.TRUE1=3]="TRUE1",e[e.TRUE2=4]="TRUE2",e[e.TRUE3=5]="TRUE3",e[e.FALSE1=6]="FALSE1",e[e.FALSE2=7]="FALSE2",e[e.FALSE3=8]="FALSE3",e[e.FALSE4=9]="FALSE4",e[e.NULL1=10]="NULL1",e[e.NULL2=11]="NULL2",e[e.NULL3=12]="NULL3",e[e.STRING_DEFAULT=13]="STRING_DEFAULT",e[e.STRING_AFTER_BACKSLASH=14]="STRING_AFTER_BACKSLASH",e[e.STRING_UNICODE_DIGIT_1=15]="STRING_UNICODE_DIGIT_1",e[e.STRING_UNICODE_DIGIT_2=16]="STRING_UNICODE_DIGIT_2",e[e.STRING_UNICODE_DIGIT_3=17]="STRING_UNICODE_DIGIT_3",e[e.STRING_UNICODE_DIGIT_4=18]="STRING_UNICODE_DIGIT_4",e[e.STRING_INCOMPLETE_CHAR=19]="STRING_INCOMPLETE_CHAR",e[e.NUMBER_AFTER_INITIAL_MINUS=20]="NUMBER_AFTER_INITIAL_MINUS",e[e.NUMBER_AFTER_INITIAL_ZERO=21]="NUMBER_AFTER_INITIAL_ZERO",e[e.NUMBER_AFTER_INITIAL_NON_ZERO=22]="NUMBER_AFTER_INITIAL_NON_ZERO",e[e.NUMBER_AFTER_FULL_STOP=23]="NUMBER_AFTER_FULL_STOP",e[e.NUMBER_AFTER_DECIMAL=24]="NUMBER_AFTER_DECIMAL",e[e.NUMBER_AFTER_E=25]="NUMBER_AFTER_E",e[e.NUMBER_AFTER_E_AND_SIGN=26]="NUMBER_AFTER_E_AND_SIGN",e[e.NUMBER_AFTER_E_AND_DIGIT=27]="NUMBER_AFTER_E_AND_DIGIT",e[e.SEPARATOR=28]="SEPARATOR",e[e.BOM_OR_START=29]="BOM_OR_START",e[e.BOM=30]="BOM"}(K||(K={}));const J={stringBufferSize:0,numberBufferSize:0,separator:void 0,emitPartialTokens:!1};class Q extends Error{constructor(e){super(e),Object.setPrototypeOf(this,Q.prototype)}}B.TokenizerError=Q;B.default=class{constructor(e){this.state=29,this.bomIndex=0,this.separatorIndex=0,this.bytes_remaining=0,this.bytes_in_sequence=0,this.char_split_buffer=new Uint8Array(4),this.encoder=new TextEncoder,this.offset=-1,e=Object.assign(Object.assign({},J),e),this.emitPartialTokens=!0===e.emitPartialTokens,this.bufferedString=e.stringBufferSize&&e.stringBufferSize>4?new x.BufferedString(e.stringBufferSize):new x.NonBufferedString,this.bufferedNumber=e.numberBufferSize&&e.numberBufferSize>0?new x.BufferedString(e.numberBufferSize):new x.NonBufferedString,this.separator=e.separator,this.separatorBytes=e.separator?this.encoder.encode(e.separator):void 0}get isEnded(){return 1===this.state}write(e){try{let t;if(e instanceof Uint8Array)t=e;else if("string"==typeof e)t=this.encoder.encode(e);else if(Array.isArray(e))t=Uint8Array.from(e);else{if(!ArrayBuffer.isView(e))throw new TypeError("Unexpected type. The `write` function only accepts Arrays, TypedArrays and Strings.");t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength)}for(let s=0;s<t.length;s+=1){const r=t[s];switch(this.state){case 29:if(e instanceof Uint8Array&&239===r){this.bom=[239,187,191],this.bomIndex+=1,this.state=30;continue}if(e instanceof Uint16Array){if(254===r){this.bom=[254,255],this.bomIndex+=1,this.state=30;continue}if(255===r){this.bom=[255,254],this.bomIndex+=1,this.state=30;continue}}if(e instanceof Uint32Array){if(0===r){this.bom=[0,0,254,255],this.bomIndex+=1,this.state=30;continue}if(255===r){this.bom=[255,254,0,0],this.bomIndex+=1,this.state=30;continue}}case 0:if(this.offset+=1,this.separatorBytes&&r===this.separatorBytes[0]){if(1===this.separatorBytes.length){this.state=0,this.onToken({token:$.default.SEPARATOR,value:this.separator,offset:this.offset+this.separatorBytes.length-1});continue}this.state=28;continue}if(32===r||10===r||13===r||9===r)continue;if(123===r){this.onToken({token:$.default.LEFT_BRACE,value:"{",offset:this.offset});continue}if(125===r){this.onToken({token:$.default.RIGHT_BRACE,value:"}",offset:this.offset});continue}if(91===r){this.onToken({token:$.default.LEFT_BRACKET,value:"[",offset:this.offset});continue}if(93===r){this.onToken({token:$.default.RIGHT_BRACKET,value:"]",offset:this.offset});continue}if(58===r){this.onToken({token:$.default.COLON,value:":",offset:this.offset});continue}if(44===r){this.onToken({token:$.default.COMMA,value:",",offset:this.offset});continue}if(116===r){this.state=3;continue}if(102===r){this.state=6;continue}if(110===r){this.state=10;continue}if(34===r){this.bufferedString.reset(),this.state=13;continue}if(r>=49&&r<=57){this.bufferedNumber.reset(),this.bufferedNumber.appendChar(r),this.state=22;continue}if(48===r){this.bufferedNumber.reset(),this.bufferedNumber.appendChar(r),this.state=21;continue}if(45===r){this.bufferedNumber.reset(),this.bufferedNumber.appendChar(r),this.state=20;continue}break;case 13:if(34===r){const e=this.bufferedString.toString();this.state=0,this.onToken({token:$.default.STRING,value:e,offset:this.offset}),this.offset+=this.bufferedString.byteLength+1;continue}if(92===r){this.state=14;continue}if(r>=128){if(this.bytes_in_sequence=r>=194&&r<=223?2:r<=239?3:4,this.bytes_in_sequence<=t.length-s){this.bufferedString.appendBuf(t,s,s+this.bytes_in_sequence),s+=this.bytes_in_sequence-1;continue}this.bytes_remaining=s+this.bytes_in_sequence-t.length,this.char_split_buffer.set(t.subarray(s)),s=t.length-1,this.state=19;continue}if(r>=32){this.bufferedString.appendChar(r);continue}break;case 19:this.char_split_buffer.set(t.subarray(s,s+this.bytes_remaining),this.bytes_in_sequence-this.bytes_remaining),this.bufferedString.appendBuf(this.char_split_buffer,0,this.bytes_in_sequence),s=this.bytes_remaining-1,this.state=13;continue;case 14:const i=z.escapedSequences[r];if(i){this.bufferedString.appendChar(i),this.state=13;continue}if(117===r){this.unicode="",this.state=15;continue}break;case 15:case 16:case 17:if(r>=48&&r<=57||r>=65&&r<=70||r>=97&&r<=102){this.unicode+=String.fromCharCode(r),this.state+=1;continue}break;case 18:if(r>=48&&r<=57||r>=65&&r<=70||r>=97&&r<=102){const e=parseInt(this.unicode+String.fromCharCode(r),16);void 0===this.highSurrogate?e>=55296&&e<=56319?this.highSurrogate=e:this.bufferedString.appendBuf(this.encoder.encode(String.fromCharCode(e))):(e>=56320&&e<=57343?this.bufferedString.appendBuf(this.encoder.encode(String.fromCharCode(this.highSurrogate,e))):this.bufferedString.appendBuf(this.encoder.encode(String.fromCharCode(this.highSurrogate))),this.highSurrogate=void 0),this.state=13;continue}break;case 20:if(48===r){this.bufferedNumber.appendChar(r),this.state=21;continue}if(r>=49&&r<=57){this.bufferedNumber.appendChar(r),this.state=22;continue}break;case 21:if(46===r){this.bufferedNumber.appendChar(r),this.state=23;continue}if(101===r||69===r){this.bufferedNumber.appendChar(r),this.state=25;continue}s-=1,this.state=0,this.emitNumber();continue;case 22:if(r>=48&&r<=57){this.bufferedNumber.appendChar(r);continue}if(46===r){this.bufferedNumber.appendChar(r),this.state=23;continue}if(101===r||69===r){this.bufferedNumber.appendChar(r),this.state=25;continue}s-=1,this.state=0,this.emitNumber();continue;case 23:if(r>=48&&r<=57){this.bufferedNumber.appendChar(r),this.state=24;continue}break;case 24:if(r>=48&&r<=57){this.bufferedNumber.appendChar(r);continue}if(101===r||69===r){this.bufferedNumber.appendChar(r),this.state=25;continue}s-=1,this.state=0,this.emitNumber();continue;case 25:if(43===r||45===r){this.bufferedNumber.appendChar(r),this.state=26;continue}case 26:if(r>=48&&r<=57){this.bufferedNumber.appendChar(r),this.state=27;continue}break;case 27:if(r>=48&&r<=57){this.bufferedNumber.appendChar(r);continue}s-=1,this.state=0,this.emitNumber();continue;case 3:if(114===r){this.state=4;continue}break;case 4:if(117===r){this.state=5;continue}break;case 5:if(101===r){this.state=0,this.onToken({token:$.default.TRUE,value:!0,offset:this.offset}),this.offset+=3;continue}break;case 6:if(97===r){this.state=7;continue}break;case 7:if(108===r){this.state=8;continue}break;case 8:if(115===r){this.state=9;continue}break;case 9:if(101===r){this.state=0,this.onToken({token:$.default.FALSE,value:!1,offset:this.offset}),this.offset+=4;continue}break;case 10:if(117===r){this.state=11;continue}break;case 11:if(108===r){this.state=12;continue}break;case 12:if(108===r){this.state=0,this.onToken({token:$.default.NULL,value:null,offset:this.offset}),this.offset+=3;continue}break;case 28:if(this.separatorIndex+=1,!this.separatorBytes||r!==this.separatorBytes[this.separatorIndex])break;this.separatorIndex===this.separatorBytes.length-1&&(this.state=0,this.onToken({token:$.default.SEPARATOR,value:this.separator,offset:this.offset+this.separatorIndex}),this.separatorIndex=0);continue;case 30:if(r===this.bom[this.bomIndex]){if(this.bomIndex===this.bom.length-1){this.state=0,this.bom=void 0,this.bomIndex=0;continue}this.bomIndex+=1;continue}break;case 1:if(32===r||10===r||13===r||9===r)continue}throw new Q(`Unexpected "${String.fromCharCode(r)}" at position "${s}" in state ${V(this.state)}`)}if(this.emitPartialTokens)switch(this.state){case 3:case 4:case 5:this.onToken({token:$.default.TRUE,value:!0,offset:this.offset,partial:!0});break;case 6:case 7:case 8:case 9:this.onToken({token:$.default.FALSE,value:!1,offset:this.offset,partial:!0});break;case 10:case 11:case 12:this.onToken({token:$.default.NULL,value:null,offset:this.offset,partial:!0});break;case 13:{const e=this.bufferedString.toString();this.onToken({token:$.default.STRING,value:e,offset:this.offset,partial:!0});break}case 21:case 22:case 24:case 27:try{this.onToken({token:$.default.NUMBER,value:this.parseNumber(this.bufferedNumber.toString()),offset:this.offset,partial:!0})}catch(e){}}}catch(e){this.error(e)}}emitNumber(){this.onToken({token:$.default.NUMBER,value:this.parseNumber(this.bufferedNumber.toString()),offset:this.offset}),this.offset+=this.bufferedNumber.byteLength-1}parseNumber(e){return Number(e)}error(e){1!==this.state&&(this.state=2),this.onError(e)}end(){switch(this.state){case 21:case 22:case 24:case 27:this.state=1,this.emitNumber(),this.onEnd();break;case 29:case 0:case 2:case 28:this.state=1,this.onEnd();break;default:this.error(new Q(`Tokenizer ended in the middle of a token (state: ${V(this.state)}). Either not all the data was received or the data was invalid.`))}}onToken(e){throw new Q('Can\'t emit tokens before the "onToken" callback has been set up.')}onError(e){throw e}onEnd(){}};var W={},q=e&&e.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(W,"__esModule",{value:!0}),W.TokenParserError=void 0;const Y=q(F);var Z;function X(e){return["VALUE","KEY","COLON","COMMA","ENDED","ERROR","SEPARATOR"][e]}!function(e){e[e.VALUE=0]="VALUE",e[e.KEY=1]="KEY",e[e.COLON=2]="COLON",e[e.COMMA=3]="COMMA",e[e.ENDED=4]="ENDED",e[e.ERROR=5]="ERROR",e[e.SEPARATOR=6]="SEPARATOR"}(Z||(Z={}));const ee={paths:void 0,keepStack:!0,separator:void 0,emitPartialValues:!1};class te extends Error{constructor(e){super(e),Object.setPrototypeOf(this,te.prototype)}}W.TokenParserError=te;W.default=class{constructor(e){this.state=0,this.mode=void 0,this.key=void 0,this.value=void 0,this.stack=[],(e=Object.assign(Object.assign({},ee),e)).paths&&(this.paths=e.paths.map(e=>{if(void 0===e||"$*"===e)return;if(!e.startsWith("$"))throw new te(`Invalid selector "${e}". Should start with "$".`);const t=e.split(".").slice(1);if(t.includes(""))throw new te(`Invalid selector "${e}". ".." syntax not supported.`);return t})),this.keepStack=e.keepStack||!1,this.separator=e.separator,e.emitPartialValues||(this.emitPartial=()=>{})}shouldEmit(){return!this.paths||this.paths.some(e=>{var t;if(void 0===e)return!0;if(e.length!==this.stack.length)return!1;for(let t=0;t<e.length-1;t++){const s=e[t],r=this.stack[t+1].key;if("*"!==s&&s!==r)return!1}const s=e[e.length-1];return"*"===s||s===(null===(t=this.key)||void 0===t?void 0:t.toString())})}push(){this.stack.push({key:this.key,value:this.value,mode:this.mode,emit:this.shouldEmit()})}pop(){const e=this.value;let t;({key:this.key,value:this.value,mode:this.mode,emit:t}=this.stack.pop()),this.state=void 0!==this.mode?3:0,this.emit(e,t)}emit(e,t){!this.keepStack&&this.value&&this.stack.every(e=>!e.emit)&&delete this.value[this.key],t&&this.onValue({value:e,key:this.key,parent:this.value,stack:this.stack}),0===this.stack.length&&(this.separator?this.state=6:void 0===this.separator&&this.end())}emitPartial(e){this.shouldEmit()&&(1!==this.state?this.onValue({value:e,key:this.key,parent:this.value,stack:this.stack,partial:!0}):this.onValue({value:void 0,key:e,parent:this.value,stack:this.stack,partial:!0}))}get isEnded(){return 4===this.state}write({token:e,value:t,partial:s}){try{if(s)return void this.emitPartial(t);if(0===this.state){if(e===Y.default.STRING||e===Y.default.NUMBER||e===Y.default.TRUE||e===Y.default.FALSE||e===Y.default.NULL)return 0===this.mode?(this.value[this.key]=t,this.state=3):1===this.mode&&(this.value.push(t),this.state=3),void this.emit(t,this.shouldEmit());if(e===Y.default.LEFT_BRACE){if(this.push(),0===this.mode)this.value=this.value[this.key]={};else if(1===this.mode){const e={};this.value.push(e),this.value=e}else this.value={};return this.mode=0,this.state=1,this.key=void 0,void this.emitPartial()}if(e===Y.default.LEFT_BRACKET){if(this.push(),0===this.mode)this.value=this.value[this.key]=[];else if(1===this.mode){const e=[];this.value.push(e),this.value=e}else this.value=[];return this.mode=1,this.state=0,this.key=0,void this.emitPartial()}if(1===this.mode&&e===Y.default.RIGHT_BRACKET&&0===this.value.length)return void this.pop()}if(1===this.state){if(e===Y.default.STRING)return this.key=t,this.state=2,void this.emitPartial();if(e===Y.default.RIGHT_BRACE&&0===Object.keys(this.value).length)return void this.pop()}if(2===this.state&&e===Y.default.COLON)return void(this.state=0);if(3===this.state){if(e===Y.default.COMMA){if(1===this.mode)return this.state=0,void(this.key+=1);if(0===this.mode)return void(this.state=1)}if(e===Y.default.RIGHT_BRACE&&0===this.mode||e===Y.default.RIGHT_BRACKET&&1===this.mode)return void this.pop()}if(6===this.state&&e===Y.default.SEPARATOR&&t===this.separator)return void(this.state=0);throw new te(`Unexpected ${Y.default[e]} (${JSON.stringify(t)}) in state ${X(this.state)}`)}catch(e){this.error(e)}}error(e){4!==this.state&&(this.state=5),this.onError(e)}end(){0!==this.state&&6!==this.state||this.stack.length>0?this.error(new Error(`Parser ended in mid-parsing (state: ${X(this.state)}). Either not all the data was received or the data was invalid.`)):(this.state=4,this.onEnd())}onValue(e){throw new te('Can\'t emit data before the "onValue" callback has been set up.')}onError(e){throw e}onEnd(){}};var se=e&&e.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(D,"__esModule",{value:!0});const re=se(B),ie=se(W);D.default=class{constructor(e={}){this.tokenizer=new re.default(e),this.tokenParser=new ie.default(e),this.tokenizer.onToken=this.tokenParser.write.bind(this.tokenParser),this.tokenizer.onEnd=()=>{this.tokenParser.isEnded||this.tokenParser.end()},this.tokenParser.onError=this.tokenizer.error.bind(this.tokenizer),this.tokenParser.onEnd=()=>{this.tokenizer.isEnded||this.tokenizer.end()}}get isEnded(){return this.tokenizer.isEnded&&this.tokenParser.isEnded}write(e){this.tokenizer.write(e)}end(){this.tokenizer.end()}set onToken(e){this.tokenizer.onToken=t=>{e(t),this.tokenParser.write(t)}}set onValue(e){this.tokenParser.onValue=e}set onError(e){this.tokenizer.onError=e}set onEnd(e){this.tokenParser.onEnd=()=>{this.tokenizer.isEnded||this.tokenizer.end(),e.call(this.tokenParser)}}};var ne={};Object.defineProperty(ne,"__esModule",{value:!0});var oe={};Object.defineProperty(oe,"__esModule",{value:!0});var ae={};Object.defineProperty(ae,"__esModule",{value:!0});var ue,fe={};Object.defineProperty(fe,"__esModule",{value:!0}),fe.TokenParserMode=void 0,function(e){e[e.OBJECT=0]="OBJECT",e[e.ARRAY=1]="ARRAY"}(ue||(fe.TokenParserMode=ue={})),function(t){var s=e&&e.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,i)}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),r=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return r(t,e),t},n=e&&e.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.TokenType=t.TokenParserMode=t.ParsedElementInfo=t.ParsedTokenInfo=t.JsonTypes=t.utf8=t.TokenParserError=t.TokenParser=t.TokenizerError=t.Tokenizer=t.JSONParser=void 0;var o=D;Object.defineProperty(t,"JSONParser",{enumerable:!0,get:function(){return n(o).default}});var a=B;Object.defineProperty(t,"Tokenizer",{enumerable:!0,get:function(){return n(a).default}}),Object.defineProperty(t,"TokenizerError",{enumerable:!0,get:function(){return a.TokenizerError}});var u=W;Object.defineProperty(t,"TokenParser",{enumerable:!0,get:function(){return n(u).default}}),Object.defineProperty(t,"TokenParserError",{enumerable:!0,get:function(){return u.TokenParserError}}),t.utf8=i(w),t.JsonTypes=i(ne),t.ParsedTokenInfo=i(oe),t.ParsedElementInfo=i(ae);var f=fe;Object.defineProperty(t,"TokenParserMode",{enumerable:!0,get:function(){return f.TokenParserMode}});var h=F;Object.defineProperty(t,"TokenType",{enumerable:!0,get:function(){return n(h).default}})}(U);var he=e&&e.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(M,"__esModule",{value:!0});const _e=U,Te=he(r);class de extends Te.default{constructor(e,t){super(e),this._hasWritten=!1,this.opts.fields&&this.preprocessFieldsInfo(this.opts.fields,this.opts.defaultValue),this.initTokenizer(this.opts,t)}initTokenizer(e,t={}){t.objectMode?this.tokenizer=this.getObjectModeTokenizer():e.ndjson?this.tokenizer=this.getNdJsonTokenizer(t):this.tokenizer=this.getBinaryModeTokenizer(t)}getObjectModeTokenizer(){return{write:e=>this.pushLine(e),end:()=>{this.pushHeaderIfNotWritten(),this.onEnd()}}}configureCallbacks(e,t){e.onToken=t.write.bind(this.tokenParser),e.onError=e=>this.onError(e),e.onEnd=()=>{this.tokenParser.isEnded||this.tokenParser.end()},t.onValue=({value:e})=>this.pushLine(e),t.onError=e=>this.onError(e),t.onEnd=()=>{this.pushHeaderIfNotWritten(),this.onEnd()}}getNdJsonTokenizer(e){const t=new _e.Tokenizer(Object.assign(Object.assign({},e),{separator:this.opts.eol}));return this.tokenParser=new _e.TokenParser({paths:["$"],keepStack:!1,separator:this.opts.eol}),this.configureCallbacks(t,this.tokenParser),t}getBinaryModeTokenizer(e){const t=new _e.Tokenizer(e);return t.onToken=({token:e,value:s})=>{if(e===_e.TokenType.LEFT_BRACKET)this.tokenParser=new _e.TokenParser({paths:["$.*"],keepStack:!1});else{if(e!==_e.TokenType.LEFT_BRACE)return void this.onError(new Error('Data items should be objects or the "fields" option should be included'));this.tokenParser=new _e.TokenParser({paths:["$"],keepStack:!1})}this.configureCallbacks(t,this.tokenParser),this.tokenParser.write({token:e,value:s})},t.onError=e=>this.onError(e instanceof _e.TokenizerError?new Error("Data should be a valid JSON object or array"):e),t.onEnd=()=>{this.pushHeaderIfNotWritten(),this.onEnd()},t}write(e){this.tokenizer.write(e)}end(){this.tokenizer&&!this.tokenizer.isEnded&&this.tokenizer.end()}pushHeaderIfNotWritten(){this._hasWritten||(this.opts.fields?this.pushHeader():this.onError(new Error('Data should not be empty or the "fields" option should be included')))}pushHeader(){if(this.opts.withBOM&&this.onData("\ufeff"),this.opts.header){const e=this.getHeader();this.onHeader(e),this.onData(e),this._hasWritten=!0}}pushLine(e){const t=this.preprocessRow(e);if(!this._hasWritten){if(!this.opts.fields){if("object"!=typeof t[0])throw new Error('Data items should be objects or the "fields" option should be included');this.opts.fields=this.preprocessFieldsInfo(Object.keys(t[0]),this.opts.defaultValue)}this.pushHeader()}t.forEach(e=>{const t=this.processRow(e);void 0!==t&&(this.onLine(t),this.onData(this._hasWritten?this.opts.eol+t:t),this._hasWritten=!0)})}onHeader(e){}onLine(e){}onData(e){}onError(e){}onEnd(){}}M.default=de,function(t){var s=e&&e.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.StreamParser=t.Parser=t.FormatterTypes=t.BaseParser=void 0;var i=r;Object.defineProperty(t,"BaseParser",{enumerable:!0,get:function(){return s(i).default}}),Object.defineProperty(t,"FormatterTypes",{enumerable:!0,get:function(){return i.FormatterTypes}});var n=O;Object.defineProperty(t,"Parser",{enumerable:!0,get:function(){return s(n).default}});var o=M;Object.defineProperty(t,"StreamParser",{enumerable:!0,get:function(){return s(o).default}})}(s);const{Parser:ce}=s;var Ee=t((e,{services:t,getSchema:s,database:r})=>{const{ItemsService:i}=t;function n(e,t){const s=e.collections[t];if(!s||!s.fields)return[];const r=["user_created","user_updated","sort"];return Object.keys(s.fields).filter(e=>!r.includes(e)).map(e=>{const t=s.fields[e];if("alias"===t.type&&t.meta?.special?.includes("m2m")){const s=t.meta?.one_collection;if(s)return`${e}.${e}_id.id`}return e})}function o(e){return e.split("_").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}function a(e,t){return null==e?"":Array.isArray(e)?e.map(e=>{if("object"==typeof e&&null!==e){const t=Object.keys(e).find(e=>e.endsWith("_id"));return t&&e[t]?e[t].name||e[t].id||JSON.stringify(e[t]):JSON.stringify(e)}return e}).filter(Boolean).join(", "):"object"==typeof e&&null!==e?e.name||e.id||JSON.stringify(e):String(e)}e.get("/test",(e,t)=>{t.json({success:!0,message:"Extensión de exportación de segmentos funcionando",timestamp:(new Date).toISOString(),routes:["GET /test - Prueba de conectividad","GET /export-segment/:id - Exportar personas y/o empresas de un segmento"]})}),e.get("/export-segment/:id",async(e,t)=>{try{const u=e.params.id;if(!u)return t.status(400).json({success:!1,error:"Segment ID is required"});console.log("Exportando segmento:",u);const f=await s(),h=new i("segments",{schema:f,accountability:e.accountability}),_=await h.readOne(u);if(!_)return t.status(404).json({success:!1,error:"Segment not found"});const T=n(f,"people"),d=n(f,"enterprises");console.log("Campos de personas:",T),console.log("Campos de empresas:",d);const c=(await r("segments_people_1").where("segments_id",u).select("people_id")).map(e=>e.people_id).filter(e=>e);let E=[];if(c.length>0){const t=new i("people",{schema:f,accountability:e.accountability});E=await t.readByQuery({filter:{id:{_in:c}},fields:["*"],limit:-1})}const l=(await r("segments_enterprises").where("segments_id",u).select("enterprises_id")).map(e=>e.enterprises_id).filter(e=>e);let L=[];if(l.length>0){const t=new i("enterprises",{schema:f,accountability:e.accountability});L=await t.readByQuery({filter:{id:{_in:l}},fields:["*"],limit:-1})}const A=E&&E.length>0,p=L&&L.length>0;if(!A&&!p)return t.status(404).json({success:!1,error:"No people or enterprises found in this segment"});const I={Tipo:"",Segmento:"","Segmento ID":"","Descripción Segmento":""};T.forEach(e=>{const t=e.split(".")[0];I[`Persona - ${o(t)}`]=""}),d.forEach(e=>{const t=e.split(".")[0];I[`Empresa - ${o(t)}`]=""});const R=[];A&&E.forEach(e=>{const t={...I};t.Tipo="Persona",t.Segmento=_.name||"",t["Segmento ID"]=u,t["Descripción Segmento"]=_.description||"",Object.keys(e).forEach(s=>{if("segments"!==s){const r=`Persona - ${o(s)}`;t.hasOwnProperty(r)&&(t[r]=a(e[s]))}}),R.push(t)}),p&&L.forEach(e=>{const t={...I};t.Tipo="Empresa",t.Segmento=_.name||"",t["Segmento ID"]=u,t["Descripción Segmento"]=_.description||"",Object.keys(e).forEach(s=>{if("segments"!==s){const r=`Empresa - ${o(s)}`;t.hasOwnProperty(r)&&(t[r]=a(e[s]))}}),R.push(t)});const N=(new ce).parse(R),b=`segmento_${(_.name||u).toString().replace(/[^a-zA-Z0-9]/g,"_").replace(/_+/g,"_").toLowerCase()}_${(new Date).toISOString().split("T")[0]}.csv`;t.setHeader("Content-Type","text/csv; charset=utf-8"),t.setHeader("Content-Disposition",`attachment; filename="${b}"`),t.write("\ufeff"),t.end(N),console.log(`Exportado: ${E?.length||0} personas, ${L?.length||0} empresas`)}catch(e){console.error("Error exportando segmento:",e),t.status(500).json({success:!1,error:"Export failed: "+e.message})}})});module.exports=Ee;
